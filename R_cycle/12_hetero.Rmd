# Гетероскедастичность в R

Загружаем нужные пакеты:
```{r, message=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE)

library(ggplot2) # графики
library(sandwich) # оценка Var для гетероскедастичности
library(lmtest) # 

theme_set(theme_bw())
```

Гетероскедастичность --- $Var(\epsilon_i)\neq const$.


Последствия

* Нарушены предпосылки теоремы Гаусса-Маркова. Получаемые $\hat{\beta}_{ols}$ не являются эффективными.
* Несмещенность оценок $\hat{\beta}_{ols}$ сохраняется
* Нарушены предпосылки для использования $t$-статистик. При использовании стандартных формул $t$-статистики не имеют $t$-распределения. Доверительные интервалы и проверка гипотез по стандартным формулам даёт неверные результаты.

Что делать?

* Если нужны несмещенные оценки --- ничего
* Если нужно проверять гипотезы или строить доверительные интервалы, то нужно использовать правильную формулу для $\widehat{Var}(\hat{\beta})$.
* Если нужны эффективные оценки и есть представление о том, какого вида может быть гетероскедастичность то можно взвесить наблюдения. Оценить регрессию:

\[
\frac{y_i}{\hat{\sigma}_i}=\beta_1 \frac{1}{\hat{\sigma}_i}+\beta_2 \frac{x_i}{\hat{\sigma}_i}+\frac{\epsilon_i}{\hat{\sigma}_i}
\]

* Задать другой вопрос: 
  * Вместо регрессии $y_i=\beta_1+\beta_2 x_i+\epsilon_i$ попробовать оценить регрессию $\ln(y_i)=\beta_1+\beta_2 \ln(x_i)+\epsilon_i$.
  * Оценить квантильную регрессию 

Файл доступен по ссылке [goo.gl/zL5JQ](goo.gl/zL5JQ)

```{r}
filename <- "~/science/econometrix/em301/datasets/flats_moscow.txt"
h <- read.table(filename,header=TRUE)

qplot(totsp,price,data=h)
```

```{r}
m1 <- lm(price~totsp,data=h)
summary(m1)
confint(m1)
vcov(m1)
coeftest(m1)
```

```{r}
vcovHC(m1)
coeftest(m1,vcov=vcovHC(m1))
```

Доверительный интервал надо строить руками...
```{r}

```


Вектор весов `weights` должен быть обратно пропорционален дисперсиям, т.е. $w_i=1/\sigma^2_i$.
```{r}
model<- lm(price~totsp, weights=I(1/totsp), data=h)
summary(model)
```






### Тесты на гетероскедастичность

Тесты на гетероскедастичность устроены похожим образом:

* Оценивается исходная регрессия и из неё получаются остатки $\hat{\varepsilon}_i$.
* Если верить в гомоскедастичность, то дисперсия вектора остатков определяется по формуле $Var(\hat{\varepsilon})=\sigma^2 (I-X(X'X)^{-1}X')$. Т.е. дисперсия у остатков разная (!) даже если $Var(\varepsilon_i)=\sigma^2$. Поэтому остатки стандартизуют по формуле:
\[
s_i = \frac{\varepsilon_i}{\sqrt{\hat{\sigma}^2(I-X(X'X)^{-1}X')_{ii}}}
\]
Остатки полученные после такого преобразования называют стандартизированными или иногда стьюдентизированными. 
* Графически или с помощью формальных тестов проверяется гипотеза о постоянстве разброса стандартизированных остатков $s_i$. Например, можно построить регрессию величины $s_i^2$ или $|s_i|$ на переменную, от которой предположительно зависит $Var(\varepsilon_i)$.

Графически
```{r}
m1.st.resid <- rstandard(m1) # получаем стандартизированные остатки
qplot(totsp,abs(m1.st.resid),data=h,alpha=0.05)
```


Тест Бройша-Пагана, Breusch-Pagan:
* Оценивается регрессия $y_i=\beta_1+\beta_2 x_i +\varepsilon_i$
* Стандартизируются остатки
* Оценивается регрессия $s_i^2=\beta_1+\beta_2 x_i +\varepsilon_i$

При верной $H_0$ асимптотически:
\[
nR^2 \sim \chi^2_{p-1}
\]
, где $p$ --- число оцениваемых коэффициентов во вспомогательной регрессии. По смыслу $(p-1)$ --- это количество факторов, от которых потенциально может зависеть дисперсия $Var(\varepsilon_i)$.

Тест Бройша-Пагана в R:
```{r}
bptest(m1)
```


Иногда для простоты пропускают второй шаг со стандартизацией остатков и в результате могут ошибочно принять принять разную $Var(\hat{\varepsilon}_i)$ за гетероскедастичность, т.е. за разную $Var(\varepsilon_i)$. Впрочем, если гетероскедастичность сильная, то её будет видно и на нестандартизированных остатках.


Тест Goldfeld-Quandt. Не требует стьюдентизации остатков. Не требует указания конкретного вида подозреваемой гетероскедастичности.

* Упорядочить наблюдения в том порядке, в котором подозревается рост гетероскедастичности
* Выкинуть некий процент наблюдений по середине, чтобы подчеркнуть разницу в дисперсии между начальными и конечными наблюдениями.
* Оценить исходную модель по наблюдениям из начала выборки и по наблюдениям конца выборки
* Получить, соответственно, $RSS_1$ и $RSS_2$

При верной $H_0$
\[
\frac{RSS_2}{RSS_1}\sim F_{r-k,r-k}
\]
, где $r$ --- размер подвыборки в начале и в конце.


Тест Голдфельда-Квандта в R:
```{r}
h2 <- h[order(h$totsp),] # сменим порядок строк в табличке h
m2 <- lm(price~totsp,data=h2) 
gqtest(m2,fraction=0.2) # проведем GQ тест выкинув посередине 20% наблюдений
```




### Тестирование и борьба с гетероскедастичностью

Чайники часто используют такой *ошибочный* подход:

Протестировать гетероскедастичность. Если тесты выявили гетероскедастичность, то бороться с ней (использовать устойчивые стандартные ошибки или применять взвешенный мнк). Если тесты не выявили гетероскедастичность, то не бороться с ней.

Этот подход неверен!

Правильно делать так:

* Если есть теоретические основания ожидать гетероскедастичность и наблюдений достаточно, то использовать устойчивые стандартные ошибки вне зависимости от результатов тестирования.
* Если есть теоретические основания ожидать гетероскедастичность  и наблюдений мало, то отказаться от девичьих грёз об эффективности оценок и проверке гипотез. Довольствоваться возможной несмещенностью оценок.



