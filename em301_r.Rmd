Эконометрика в R
========================================================


### Базовые команды операционной системы

Linux/MacOs
1. Узнать текущую рабочую директорию:
```
pwd
```
2. Сменить директорию:
```
cd target_folder
```
Не забывайте, что в командной строке работает <Tab> и клавиши вверх, вниз.
3. Посмотреть список файлов в текущей директории:
```
ls
```
4. Создать папку
```
mkdir the_new_folder
```
5. Запустить скрипт R
```
Rscript file_to_run.R
```


Windows:
1. Узнать текущую рабочую директорию:
```
???
```
2. Сменить директорию:
```
cd target_folder
```
Не забывайте, что в командной строке работает <Tab> и клавиши вверх, вниз.
3. Посмотреть список файлов в текущей директории:
```
dir
```
4. Создать папку
```
mkdir the_new_folder
```
5. Запустить скрипт R
```
C:\path_to_R\Rscript file_to_run.R
```
По умолчанию в Windows для запуска программы нужно указывать её полный путь. Чтобы этого не делать каждый раз, а писать коротко `Rscript file_to_run.R`, нужно внести путь к папке с R в переменную $PATH. Для этого...



### Навигация по папкам:

1. Узнать текущую рабочую директорию:
```{r}
getwd()
```
2. Установить рабочую директорию:
```{r}
setwd('/home/boris/')
```
Не забывайтие, что в R-studio работает <Tab>!
3. Посмотреть список файлов в текущей директории:
```{r}
dir()
```
Можно указать пролистываемую папку, `dir('folder')`
4. Создать папку
```{r}
dir.create('the_new_folder')
```
5. Сохранить историю набранных команд:
```{r}
savehistory('log_file.txt')
```
6. Запустить скрипт не выходя из R:
```{r}
source('script_to_run.txt')
```
7. Выйти из R `quit()` или коротко `q()`

На дворе 21 век, тем не менее:
* Не используйте в именах папок русские буквы
* Не используйте в именах папок пробелы

### Получение справки

Справка по конкретной команде
```{r}
?t.test
```

Поиск нужной команды по ключевому слову
```{r}
??anova
```

А дальше имеет смысл искать в интернете. Имеет смысл гуглить по фразе "something I need in R". Если поиск не увенчался успехом, то тогда имеет смысл задать вопрос на одном из форумов: 
* [stats.stackexchange.com](http://stats.stackexchange.com) - по реализации статистических методов на R
* [stackoverflow.com](http://stackoverflow.com) - по программированию в целом



### Типы переменных

Самый простой тип --- количественные переменные.

```{r}
x=c(1.5,2.4,3.6) 
y=c('Аня','Маша','Ира','Света') 
z=c(TRUE,FALSE,TRUE) 
w=c('Да','Да','Не знаю','Нет','Не знаю') 
```

Более интересный тип, **качественные** данные. Текстовые можно легко преобразовать в качественные:
```{r}
w2=as.factor(w)
```

Качественные данные занимают в памяти комьютера меньше места и для них есть множество специальных функций. Частный случай, **качественные порядковые** переменные
```{r}
stud=ordered(c('Школьник','Бакалавр','Бакалавр','Школьник','Магистр','Школьник','Магистр','Бакалавр'),levels=c('Школьник','Бакалавр','Магистр'))
stud
```

Переменные могут быть организованы:

В векторы:


В матрицы:


Маленькая техническая подробность. На самом деле R хранит любую матрицу в виде вектора с дополнительной пометкой, атрибутом, о размере матрицы.
Узнаём размер матрицы:
```{r}
dim(mat)
```
Можно использовать и более длинную, но зато универсальную команду, подходяющую для всех атрибутов, `attr(mat,'dim')`.



В списки:


Несколько переменных может быть организовано в таблицу данных *dataframe*

Переменную из таблицы данных можно вытащить с помощью `df['x']` или, короче, `df$x`.

Помимо переменных у таблицы с данными может быть куча атрибутов. Атрибут может нести любую вспомогательную информацию. Самым распространённый атрибут, имена переменных, `attr(df,'names')`. В силу его распространённости для него есть короткая команда `names(df)`.

Настоятельно рекомендую добавлять атрибут `var_labels` с более подробным описанием
переменных, подобно variable labels в Стате
```{r}
attr(df,'var_labels')=c('Прожиточный минимум в 3042 году согласно исследованиям 2012 года','Просто какая-то переменная')
```

Чтобы узнать, что за объект перед нами, используем, `str()`
```{r}
str(stud)
```

### Загрузка данных из STATA, SPSS, ...

Загрузка файла STATA
```{r}
library(foreign)
df = read.dta('myfile.dta')
```

В качестве атрибутов сохраняются названия и описания переменных:
```{r}
attr(df,'names')
attr(df,'var.labels')
```

Вместо `attr(df,'names')` можно писать коротко `names(df)`. Атрибут `var.labels` используется реже, поэтому для него более короткой команды нет. (хм, а вдруг есть?)  

Чтобы посмотреть, что ещё оказалось в таблице с данными, можно использовать функцию `str(df)`.


### Рисование графиков

Можно рисовать графики встроенными средствами R, но для более качественных графиков мы будем использовать пакет `ggplot2`
```{r}
library(ggplot2)
```


Самые часто употребимые типы 

```{r fig.width=7, fig.height=6}
plot(cars)
```



### Оценка простой модели регрессии

Линейная регрессия оценивается командой:
```{r}
res<-lm(y~x+z,data=df)
```

Отчёт о результатах
```{r}
summary(res)
```

Из списка результатов для дальнейшей работы можно раздобыть коэффициенты, вектор остатков, вектор оценённых зависимых переменных и многое другое:
```{r}
coef(res)
residuals(res)
fitted.values(res)
```

Посмотреть, что ещё есть в списке легко:
```{r}
names(res)
```
Можно также использовать `str(res)`.

Оценка ковариационной матрицы считается дополнительно,
```{r}
vcov(res)
```









### Установка пакетов в R
Для установки пакетов нужно соединение с интернетом. Установим, например, пакет `vcd` для мозаичных графиков
```{r}
install.packages('vcd')
```
После установки пакета на компьютер, его можно загрузить
```{r}
library(vcd)
```
И использовать...



### MLE in R

Хорошие мелочи: 

* Функцию называть mlog, чтобы подчеркнуть, что это минус функция правдоподобия. 
* Чтобы это было видно в ней самой она должна выглядеть примерно так:

```{r}
mlog <- function(params,data) {
# это функция вычисляет функцию правдоподобия со знаком минус    
    logl = tra-ta-ta
    return(-logl)
}
``` 




### MCMC

Можно применять метод MCMC используя только сам R. Но это не самый продуктивный способ, для этого существенно более быстрые специальные пакеты. Мы будем использовать [JAGS](http://mcmc-jags.sourceforge.net/). Это отдельный пакет, в котором есть свой язык описания моделей, и его, в принципе, можно использовать отдельно от R. Для вызова JAGS из R, нужно установить дополнительный пакет, `rjags`. Делается это командой `install.packages('rjags')` из R.


```{r}
library(rjags)
```


Происшествия на английских угольных шахтах без JAGS:







Происшествия на английских угольных шахтах с JAGS:


Из кода видно, что нам не приходится выводить вручную условные распределения. На самом деле мы всего лишь описываем модель в дерева (направленного ациклического графа).

(картинка)


Из описания модели в виде графа можно получить условную функцию плотности параметра $\theta$ по теореме
$$
f(\theta|G-\theta) \sim f(\theta|parents(\theta))\cdot \prod_{a
\in children(\theta)}f(a|parents(a))
$$

Схематично JAGS поступает так:

* По теореме выясняет условное распределение каждого параметра $\theta$. 
* Если JAGS обнаружит сопряженность и стандартное распределение, то он будет их использовать при генерировании $\theta$. 
* Если JAGS не обнаружит сопряженных распределений, то он прибегнет к алгоритму Метрополиса для генерирования $\theta$. 







